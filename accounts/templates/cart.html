{% extends 'base.html' %}

{% block content %}
{% load cart_extras %}
<div class="container mt-4">
    <h2>Your Cart</h2>

    {% if grouped_items %}
        {% for farmer, items in grouped_items.items %}
        <h4>Farmer: {{ farmer.username }}</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Subtotal</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>
                        {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" width="50">
                        {% endif %}
                        {{ item.product.name }}
                    </td>
                    <td>
                        <a href="{% url 'update_cart_quantity' item.id 'decrease' %}" class="btn btn-sm btn-secondary">-</a>
                        {{ item.quantity }}
                        <a href="{% url 'update_cart_quantity' item.id 'increase' %}" class="btn btn-sm btn-secondary">+</a>
                    </td>
                    <td>{{ item.product.price_per_unit }}</td>
                    <td>{{ item.quantity|mul:item.product.price_per_unit|floatformat:2 }}</td>
                    <td>
                        <a href="{% url 'remove_from_cart' item.id %}" class="btn btn-danger btn-sm">Remove</a>
                        {% if not item.saved_for_later %}
                        <a href="{% url 'save_for_later' item.id %}" class="btn btn-info btn-sm">Save for Later</a>
                        {% else %}
                        <a href="{% url 'move_to_cart' item.id %}" class="btn btn-primary btn-sm">Move to Cart</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}

        <!-- Cart Summary -->
        {% comment %} Calculate subtotal manually {% endcomment %}
        {% with 0 as subtotal %}
            {% for farmer, items in grouped_items.items %}
                {% for item in items %}
                    {% with item.quantity|floatformat:2|mul:item.product.price_per_unit as item_total %}
                        {% with subtotal|add:item_total as subtotal %}
                        {% endwith %}
                    {% endwith %}
                {% endfor %}
            {% endfor %}
            <div class="card mt-3 p-3">
                <h5>Cart Summary</h5>
                <p>Subtotal: {{ subtotal }}</p>
                <p>Delivery estimate: 200</p>
                <p>Taxes: 0</p>
                <p><strong>Total: {{ subtotal|add:200 }}</strong></p>
                <a href="{% url 'checkout' %}" class="btn btn-success">Proceed to Checkout</a>

            </div>
        {% endwith %}

    {% else %}
        <p>Your cart is empty. <a href="{% url 'product_list' %}">Browse Products</a></p>
    {% endif %}
</div>
{% endblock %}
